<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cultivation Sect Leader Simulator</title>
  <style>
    :root {
      --bg: #090c13;
      --panel: #111827;
      --panel-soft: #1a2438;
      --text: #e5ebf7;
      --muted: #93a2c4;
      --accent: #8876ff;
      --border: #2a3752;
      --good: #6fe0ac;
      --bad: #ff8299;
      --warn: #f2c86b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Inter, "Segoe UI", Roboto, sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #141b2d 0%, var(--bg) 55%);
      color: var(--text);
      padding: 24px;
      display: flex;
      justify-content: center;
    }

    .app {
      width: min(1040px, 100%);
      display: grid;
      gap: 14px;
    }

    .card {
      background: linear-gradient(160deg, var(--panel) 0%, #0d1422 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      padding: 14px;
    }

    h1 {
      font-size: 1.5rem;
      letter-spacing: 0.03em;
      margin-bottom: 12px;
    }

    .stats {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .stat {
      background: linear-gradient(180deg, rgba(136, 118, 255, 0.15), rgba(136, 118, 255, 0.06));
      border: 1px solid rgba(136, 118, 255, 0.3);
      border-radius: 10px;
      padding: 10px;
    }

    .stat small {
      color: var(--muted);
      display: block;
      font-size: 0.77rem;
      margin-bottom: 4px;
    }

    .stat strong {
      font-size: 1.04rem;
      font-weight: 650;
    }

    .turn {
      color: var(--muted);
      margin-bottom: 8px;
      display: inline-block;
    }

    .event-text {
      line-height: 1.6;
      color: #d5def2;
      margin-bottom: 12px;
      min-height: 68px;
    }

    .choices {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    button {
      border: 1px solid #3a4d73;
      background: #1c2740;
      color: var(--text);
      border-radius: 9px;
      padding: 11px;
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      transition: 0.18s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      background: #273557;
      border-color: #5a74a8;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .action-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    #rewindBtn {
      background: #3b2247;
      border-color: #7b45a1;
    }

    #restartBtn {
      background: #1f304b;
      border-color: #3f679b;
    }

    .status {
      min-height: 20px;
      margin-top: 10px;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .chronicle {
      max-height: 240px;
      overflow: auto;
      display: grid;
      gap: 8px;
      padding-right: 4px;
    }

    .log {
      border-left: 3px solid var(--accent);
      padding-left: 8px;
      font-size: 0.92rem;
      color: #c7d4ef;
      line-height: 1.35;
    }

    .good { color: var(--good); }
    .bad { color: var(--bad); }
    .warn { color: var(--warn); }

    @media (max-width: 880px) {
      .stats, .choices { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 560px) {
      body { padding: 12px; }
      .stats, .choices { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="card">
      <h1>Cultivation Sect Leader Simulator</h1>
      <div id="stats" class="stats"></div>
    </section>

    <section class="card">
      <span id="turnLabel" class="turn"></span>
      <p id="eventText" class="event-text"></p>
      <div id="choices" class="choices"></div>
      <div id="status" class="status"></div>
      <div class="action-row">
        <button id="rewindBtn" disabled>Use Heavenly Fate Rewind</button>
        <button id="restartBtn">Restart</button>
      </div>
    </section>

    <section class="card">
      <h2 style="font-size:1.08rem; margin-bottom:10px;">Sect Chronicle</h2>
      <div id="log" class="chronicle"></div>
    </section>
  </main>

  <script>
    const SEASONS = ["Spring", "Summer", "Autumn", "Winter"];

    const STAT_RULES = {
      sectPower: { min: -999, max: 240 },
      disciples: { min: 0, max: 500 },
      spiritStones: { min: -250, max: 1500 },
      reputation: { min: 0, max: 100 },
      loyalty: { min: 0, max: 100 },
      heavenlyFateTokens: { min: 0, max: 9 }
    };

    const REALM_STAGES = [
      { name: "Qi Gathering", threshold: 0 },
      { name: "Foundation Establishment", threshold: 60 },
      { name: "Core Formation", threshold: 110 },
      { name: "Nascent Soul", threshold: 170 }
    ];

    const BASE_EVENTS = [
      {
        text: "A rogue elder from a rival sect requests asylum, offering forbidden techniques.",
        choices: [
          { label: "Accept and bind with oath", effects: { sectPower: 4, loyalty: -4, reputation: -3 } },
          { label: "Refuse and escort away", effects: { sectPower: -2, reputation: 3, loyalty: 1 } },
          { label: "Detain for interrogation", effects: { spiritStones: 10, sectPower: 2, reputation: -6, loyalty: -4 } },
          { label: "Offer supplies and safe passage", effects: { spiritStones: -8, reputation: 4, loyalty: 3 } }
        ]
      },
      {
        text: "A spirit mine vein destabilizes under qi turbulence.",
        choices: [
          { label: "Fund full reinforcement", effects: { spiritStones: -16, sectPower: 3, disciples: 1 } },
          { label: "Seal the mine", effects: { sectPower: -3, loyalty: 2, reputation: 1 } },
          { label: "Force continued extraction", effects: { spiritStones: 16, loyalty: -7, disciples: -2 } },
          { label: "Invite allied oversight", effects: { reputation: 3, spiritStones: 5, sectPower: 1 } }
        ]
      },
      {
        text: "A rare heavenly omen appears above your peak, drawing wandering cultivators.",
        choices: [
          { label: "Open guided meditation sessions", effects: { reputation: 5, spiritStones: -7, disciples: 2 } },
          { label: "Monopolize the omen", effects: { sectPower: 3, reputation: -4, loyalty: -2 } },
          { label: "Auction viewing rights", effects: { spiritStones: 14, reputation: -2, sectPower: 1 } },
          { label: "Study omen privately", effects: { sectPower: 2, loyalty: 2 } }
        ]
      },
      {
        text: "Outer disciples protest dangerous assignments and poor distribution of resources.",
        choices: [
          { label: "Raise stipends", effects: { spiritStones: -13, loyalty: 7, reputation: 1 } },
          { label: "Suppress complaints", effects: { loyalty: -7, sectPower: 2 } },
          { label: "Selective promotions", effects: { sectPower: 3, loyalty: -3, disciples: -1 } },
          { label: "Delegate to elders", effects: { loyalty: 3, reputation: 2, spiritStones: -5 } }
        ]
      },
      {
        text: "Demonic beasts spill into nearby mortal settlements under your banner’s protection.",
        choices: [
          { label: "Lead direct counteroffensive", effects: { sectPower: 4, disciples: -2, reputation: 6 } },
          { label: "Defend sect only", effects: { sectPower: 2, reputation: -7, loyalty: -4 } },
          { label: "Hire independent cultivators", effects: { spiritStones: -12, reputation: 4, sectPower: 2 } },
          { label: "Evacuate villages with talismans", effects: { spiritStones: -7, loyalty: 4, reputation: 5 } }
        ]
      }
    ];

    const initialState = () => ({
      sectName: "Azure Ascendant Sect",
      leaderRealm: "Qi Gathering",
      realmStage: 0,
      sectPower: 35,
      disciples: 24,
      spiritStones: 90,
      reputation: 22,
      loyalty: 68,
      heavenlyFateTokens: 3,
      turn: 1,
      seasonIndex: 0,
      lost: false
    });

    let state = initialState();
    let previousTurn = null;
    let currentEvent = null;

    const els = {
      stats: document.getElementById("stats"),
      turnLabel: document.getElementById("turnLabel"),
      eventText: document.getElementById("eventText"),
      choices: document.getElementById("choices"),
      status: document.getElementById("status"),
      log: document.getElementById("log"),
      rewindBtn: document.getElementById("rewindBtn"),
      restartBtn: document.getElementById("restartBtn")
    };

    function clampValue(key, value) {
      const rule = STAT_RULES[key];
      if (!rule) return value;
      return Math.min(rule.max, Math.max(rule.min, value));
    }

    function clampStats() {
      Object.keys(STAT_RULES).forEach((key) => {
        state[key] = clampValue(key, state[key]);
      });
    }

    function difficultyMultiplier() {
      const tiers = Math.floor(state.sectPower / 40);
      return Math.min(2.2, 1 + tiers * 0.14);
    }

    function scaleEvent(event) {
      const mult = difficultyMultiplier();
      const clone = structuredClone(event);

      clone.choices = clone.choices.map((choice) => {
        const next = { ...choice, effects: { ...choice.effects } };
        Object.entries(next.effects).forEach(([stat, delta]) => {
          if (typeof delta !== "number") return;
          if (delta > 0) {
            next.effects[stat] = Math.max(1, Math.round(delta / mult));
          } else if (delta < 0) {
            next.effects[stat] = Math.min(-1, Math.round(delta * mult));
          }
        });
        return next;
      });

      return clone;
    }

    function pickEvent() {
      const idx = Math.floor(Math.random() * BASE_EVENTS.length);
      return scaleEvent(BASE_EVENTS[idx]);
    }

    function updateRealmProgression() {
      let reached = 0;
      for (let i = 0; i < REALM_STAGES.length; i += 1) {
        if (state.sectPower >= REALM_STAGES[i].threshold) reached = i;
      }

      if (reached > state.realmStage) {
        state.realmStage += 1;
        state.leaderRealm = REALM_STAGES[state.realmStage].name;
        addLog(`<strong>Realm Breakthrough:</strong> Leader advanced to ${state.leaderRealm}.`);
      }
    }

    function applySpiritStoneDebtPenalty() {
      if (state.spiritStones < 0) {
        const penalty = Math.max(1, Math.ceil(Math.abs(state.spiritStones) / 25));
        state.loyalty -= penalty;
        addLog(`<span class="warn"><strong>Debt Pressure:</strong> -${penalty} Loyalty from spirit stone deficit.</span>`);
      }
    }

    function applyEffects(effects) {
      Object.entries(effects).forEach(([stat, delta]) => {
        if (typeof delta === "number" && stat in state) state[stat] += delta;
      });

      applySpiritStoneDebtPenalty();
      clampStats();
      updateRealmProgression();
    }

    function addLog(html) {
      const line = document.createElement("div");
      line.className = "log";
      line.innerHTML = html;
      els.log.prepend(line);
    }

    function summarizeEffects(effects) {
      return Object.entries(effects)
        .map(([k, v]) => `<span class="${v < 0 ? "bad" : "good"}">${v > 0 ? "+" : ""}${v} ${k}</span>`)
        .join(", ");
    }

    function statsData() {
      return [
        ["Sect Name", state.sectName],
        ["Leader Realm", state.leaderRealm],
        ["Sect Power", state.sectPower],
        ["Disciples", state.disciples],
        ["Spirit Stones", state.spiritStones],
        ["Reputation", state.reputation],
        ["Loyalty", state.loyalty],
        ["Heavenly Fate Tokens", state.heavenlyFateTokens]
      ];
    }

    function renderStats() {
      els.stats.innerHTML = "";
      statsData().forEach(([label, value]) => {
        const card = document.createElement("div");
        card.className = "stat";
        card.innerHTML = `<small>${label}</small><strong>${value}</strong>`;
        els.stats.appendChild(card);
      });
    }

    function renderEvent() {
      els.turnLabel.textContent = `Turn ${state.turn} · ${SEASONS[state.seasonIndex]}`;
      els.eventText.textContent = currentEvent.text;
      els.choices.innerHTML = "";

      currentEvent.choices.forEach((choice, i) => {
        const btn = document.createElement("button");
        btn.textContent = `${i + 1}. ${choice.label}`;
        btn.addEventListener("click", () => resolveChoice(choice));
        els.choices.appendChild(btn);
      });

      els.rewindBtn.disabled = true;
      els.status.textContent = "Choose your decree for this season.";
    }

    function checkLoseCondition() {
      if (state.sectPower <= 0) {
        state.lost = true;
        Array.from(els.choices.querySelectorAll("button")).forEach((b) => (b.disabled = true));

        if (state.heavenlyFateTokens > 0 && previousTurn) {
          els.status.textContent = "Sect collapse. Spend 1 Heavenly Fate Token to rewind one turn.";
          els.rewindBtn.disabled = false;
        } else {
          els.status.textContent = "Your sect has fallen. Heavenly Fate is exhausted.";
        }
      }
    }

    function resolveChoice(choice) {
      if (state.lost) return;

      previousTurn = {
        state: structuredClone(state),
        event: structuredClone(currentEvent)
      };

      applyEffects(choice.effects);
      addLog(`<strong>${SEASONS[state.seasonIndex]} Turn ${state.turn}:</strong> ${choice.label}<br>${summarizeEffects(choice.effects)}`);

      checkLoseCondition();
      renderStats();

      if (!state.lost) {
        state.turn += 1;
        state.seasonIndex = (state.seasonIndex + 1) % SEASONS.length;
        currentEvent = pickEvent();
        renderEvent();
      }
    }

    function rewindTurn() {
      if (!state.lost || !previousTurn || state.heavenlyFateTokens <= 0) return;

      const remaining = state.heavenlyFateTokens - 1;
      state = structuredClone(previousTurn.state);
      state.heavenlyFateTokens = remaining;
      state.lost = false;
      currentEvent = structuredClone(previousTurn.event);

      addLog("<strong>Heavenly Fate Reversal:</strong> Causality rewound by one turn.");
      renderStats();
      renderEvent();
      els.status.textContent = "You rewound fate. Choose a different path.";
    }

    function restart() {
      state = initialState();
      previousTurn = null;
      currentEvent = pickEvent();
      els.log.innerHTML = "";
      addLog("<strong>New Era:</strong> You inherit the sect and face the first season.");
      renderStats();
      renderEvent();
    }

    els.rewindBtn.addEventListener("click", rewindTurn);
    els.restartBtn.addEventListener("click", restart);

    restart();
  </script>
</body>
</html>
