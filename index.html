<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cultivation Sect Leader Simulator</title>
  <style>
    :root {
      --bg: #090c14;
      --panel: #121a28;
      --panel-2: #182235;
      --text: #e5ebf7;
      --muted: #95a3bf;
      --accent: #8d7bff;
      --border: #2d3c57;
      --good: #74dfa8;
      --bad: #ff859a;
      --warn: #f2cb73;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Inter, Roboto, sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #17213a 0%, var(--bg) 55%);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 24px 14px;
    }

    .app {
      width: min(1060px, 100%);
      display: grid;
      gap: 14px;
    }

    .panel {
      background: linear-gradient(150deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.36);
    }

    h1 {
      font-size: 1.5rem;
      letter-spacing: 0.03em;
      margin-bottom: 12px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .stat-card {
      background: rgba(141, 123, 255, 0.1);
      border: 1px solid rgba(141, 123, 255, 0.3);
      border-radius: 10px;
      padding: 10px;
    }

    .stat-card small {
      display: block;
      color: var(--muted);
      font-size: 0.78rem;
      margin-bottom: 4px;
    }

    .stat-card strong {
      font-size: 1.03rem;
      font-weight: 620;
    }

    #turnLabel {
      color: var(--muted);
      display: inline-block;
      margin-bottom: 8px;
    }

    #eventText {
      min-height: 64px;
      line-height: 1.58;
      color: #d4def4;
      margin-bottom: 12px;
    }

    .choices {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    button {
      padding: 11px;
      border-radius: 9px;
      border: 1px solid #3b4f76;
      background: #1d2942;
      color: var(--text);
      text-align: left;
      font-size: 0.95rem;
      cursor: pointer;
      transition: 0.18s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      background: #27395c;
      border-color: #6582ba;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #rewindBtn {
      background: #3b2349;
      border-color: #7a43a3;
    }

    #restartBtn {
      background: #1e314f;
      border-color: #3e679e;
    }

    #status {
      margin-top: 10px;
      min-height: 20px;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .chronicle {
      max-height: 260px;
      overflow: auto;
      display: grid;
      gap: 8px;
      padding-right: 4px;
    }

    .log-item {
      border-left: 3px solid var(--accent);
      padding-left: 8px;
      color: #c8d6f0;
      line-height: 1.35;
      font-size: 0.92rem;
    }

    .good { color: var(--good); }
    .bad { color: var(--bad); }
    .warn { color: var(--warn); }

    @media (max-width: 900px) {
      .stats,
      .choices {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 560px) {
      .stats,
      .choices {
        grid-template-columns: 1fr;
      }

      body {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="panel">
      <h1>Cultivation Sect Leader Simulator</h1>
      <div id="stats" class="stats"></div>
    </section>

    <section class="panel">
      <span id="turnLabel"></span>
      <p id="eventText"></p>
      <div id="choices" class="choices"></div>
      <div id="status"></div>
      <div class="actions">
        <button id="rewindBtn" disabled>Use Heavenly Fate Rewind</button>
        <button id="restartBtn">Restart</button>
      </div>
    </section>

    <section class="panel">
      <h2 style="font-size: 1.08rem; margin-bottom: 10px;">Sect Chronicle</h2>
      <div id="log" class="chronicle"></div>
    </section>
  </main>

  <script>
    const SEASONS = ["Spring", "Summer", "Autumn", "Winter"];

    const STAT_LIMITS = {
      sectPower: { min: -999, max: 260 },
      disciples: { min: 0, max: 500 },
      spiritStones: { min: -300, max: 1800 },
      reputation: { min: 0, max: 100 },
      loyalty: { min: 0, max: 100 },
      heavenlyFateTokens: { min: 0, max: 9 }
    };

    const REALM_STAGES = [
      { name: "Qi Gathering", threshold: 0 },
      { name: "Foundation Establishment", threshold: 65 },
      { name: "Core Formation", threshold: 120 },
      { name: "Nascent Soul", threshold: 180 }
    ];

    const BASE_EVENTS = [
      {
        text: "A rogue elder from a rival sect seeks sanctuary with dangerous manuals in hand.",
        choices: [
          { label: "Accept under strict oath", effects: { sectPower: 4, loyalty: -4, reputation: -3 } },
          { label: "Refuse and escort out", effects: { sectPower: -2, reputation: 3, loyalty: 1 } },
          { label: "Detain and interrogate", effects: { spiritStones: 10, sectPower: 2, reputation: -6, loyalty: -4 } },
          { label: "Grant safe passage", effects: { spiritStones: -8, reputation: 4, loyalty: 3 } }
        ]
      },
      {
        text: "A spirit mine vein destabilizes as subterranean qi current spikes.",
        choices: [
          { label: "Pay for full reinforcement", effects: { spiritStones: -15, sectPower: 3, disciples: 1 } },
          { label: "Seal the mine now", effects: { sectPower: -3, loyalty: 2, reputation: 1 } },
          { label: "Force extraction to continue", effects: { spiritStones: 15, loyalty: -7, disciples: -2 } },
          { label: "Share management with allies", effects: { spiritStones: 5, reputation: 3, sectPower: 1 } }
        ]
      },
      {
        text: "A rare heavenly omen appears over the sect mountain, drawing outside cultivators.",
        choices: [
          { label: "Host guided enlightenment forum", effects: { reputation: 5, spiritStones: -7, disciples: 2 } },
          { label: "Restrict and monopolize omen", effects: { sectPower: 3, reputation: -4, loyalty: -2 } },
          { label: "Auction omen access", effects: { spiritStones: 13, reputation: -2, sectPower: 1 } },
          { label: "Meditate in seclusion", effects: { sectPower: 2, loyalty: 2 } }
        ]
      },
      {
        text: "Outer disciples protest dangerous missions and uneven resource distribution.",
        choices: [
          { label: "Increase stipends", effects: { spiritStones: -12, loyalty: 7, reputation: 1 } },
          { label: "Suppress dissent", effects: { loyalty: -7, sectPower: 2 } },
          { label: "Promote elite disciples only", effects: { sectPower: 3, loyalty: -3, disciples: -1 } },
          { label: "Let elders arbitrate", effects: { loyalty: 3, reputation: 2, spiritStones: -5 } }
        ]
      },
      {
        text: "Demonic beasts raid nearby mortal settlements under your nominal protection.",
        choices: [
          { label: "Lead direct suppression", effects: { sectPower: 4, disciples: -2, reputation: 6 } },
          { label: "Fortify sect and ignore villages", effects: { sectPower: 2, reputation: -7, loyalty: -4 } },
          { label: "Hire wandering cultivators", effects: { spiritStones: -11, reputation: 4, sectPower: 2 } },
          { label: "Evacuate with talismans", effects: { spiritStones: -7, loyalty: 4, reputation: 5 } }
        ]
      }
    ];

    const REBELLION_CRISES = [
      {
        name: "Elder Coup",
        apply: () => {
          state.sectPower -= 25;
          state.reputation -= 10;
          return "<span class='bad'><strong>Internal Rebellion - Elder Coup:</strong> -25 Sect Power, -10 Reputation.</span>";
        }
      },
      {
        name: "Inner Disciple Betrayal",
        apply: () => {
          state.sectPower -= 15;
          state.disciples -= 5;
          return "<span class='bad'><strong>Internal Rebellion - Inner Disciple Betrayal:</strong> -15 Sect Power, -5 Disciples.</span>";
        }
      },
      {
        name: "Sect Split",
        apply: () => {
          state.sectPower -= 30;
          state.loyalty -= 15;
          return "<span class='bad'><strong>Internal Rebellion - Sect Split:</strong> -30 Sect Power, -15 Loyalty.</span>";
        }
      },
      {
        name: "Assassination Attempt",
        apply: () => {
          if (state.sectPower < 40) {
            state.sectPower = 0;
            return "<span class='bad'><strong>Internal Rebellion - Assassination Attempt:</strong> The sect collapses immediately.</span>";
          }
          state.sectPower -= 20;
          return "<span class='bad'><strong>Internal Rebellion - Assassination Attempt:</strong> -20 Sect Power.</span>";
        }
      }
    ];

    const initialState = () => ({
      sectName: "Azure Ascendant Sect",
      leaderRealm: "Qi Gathering",
      realmStage: 0,
      sectPower: 35,
      disciples: 24,
      spiritStones: 90,
      reputation: 22,
      loyalty: 68,
      heavenlyFateTokens: 3,
      turn: 1,
      seasonIndex: 0,
      lost: false
    });

    let state = initialState();
    let currentEvent = null;
    let previousTurnSnapshot = null;

    const ui = {
      stats: document.getElementById("stats"),
      turnLabel: document.getElementById("turnLabel"),
      eventText: document.getElementById("eventText"),
      choices: document.getElementById("choices"),
      status: document.getElementById("status"),
      log: document.getElementById("log"),
      rewindBtn: document.getElementById("rewindBtn"),
      restartBtn: document.getElementById("restartBtn")
    };

    function logEntry(html) {
      const row = document.createElement("div");
      row.className = "log-item";
      row.innerHTML = html;
      ui.log.prepend(row);
    }

    function clampValue(key, value) {
      const limit = STAT_LIMITS[key];
      if (!limit) return value;
      return Math.min(limit.max, Math.max(limit.min, value));
    }

    function clampAllStats() {
      Object.keys(STAT_LIMITS).forEach((key) => {
        state[key] = clampValue(key, state[key]);
      });
    }

    function getDifficultyMultiplier() {
      const tier = Math.floor(state.sectPower / 40);
      return Math.min(2.3, 1 + tier * 0.14);
    }

    function scaleEventForDifficulty(event) {
      const scaled = structuredClone(event);
      const mult = getDifficultyMultiplier();

      scaled.choices = scaled.choices.map((choice) => {
        const adjusted = { ...choice, effects: { ...choice.effects } };

        Object.entries(adjusted.effects).forEach(([stat, delta]) => {
          if (typeof delta !== "number") return;
          if (delta > 0) {
            adjusted.effects[stat] = Math.max(1, Math.round(delta / mult));
          } else if (delta < 0) {
            adjusted.effects[stat] = Math.min(-1, Math.round(delta * mult));
          }
        });

        return adjusted;
      });

      return scaled;
    }

    function pickRandomEvent() {
      const idx = Math.floor(Math.random() * BASE_EVENTS.length);
      return scaleEventForDifficulty(BASE_EVENTS[idx]);
    }

    function updateRealmProgression() {
      let highestReached = 0;
      for (let i = 0; i < REALM_STAGES.length; i += 1) {
        if (state.sectPower >= REALM_STAGES[i].threshold) highestReached = i;
      }

      if (highestReached > state.realmStage) {
        state.realmStage += 1;
        state.leaderRealm = REALM_STAGES[state.realmStage].name;
        logEntry(`<strong>Realm Breakthrough:</strong> Leader reached ${state.leaderRealm}.`);
      }
    }

    function applyDebtPenalty() {
      if (state.spiritStones < 0) {
        const penalty = Math.max(1, Math.ceil(Math.abs(state.spiritStones) / 25));
        state.loyalty -= penalty;
        logEntry(`<span class='warn'><strong>Debt Pressure:</strong> -${penalty} Loyalty due to spirit stone deficit.</span>`);
      }
    }

    function rebellionChancePercent() {
      if (state.loyalty >= 30) return 0;
      return (30 - state.loyalty) * 2;
    }

    function rollInternalRebellion() {
      const chance = rebellionChancePercent();
      if (chance <= 0) return;

      logEntry(`<span class='warn'><strong>Internal Stability Check:</strong> Loyalty ${state.loyalty}, rebellion risk ${chance}%.</span>`);

      const roll = Math.random() * 100;
      if (roll >= chance) return;

      const crisis = REBELLION_CRISES[Math.floor(Math.random() * REBELLION_CRISES.length)];
      logEntry(crisis.apply());
      clampAllStats();
      updateRealmProgression();
    }

    function applyChoiceEffects(effects) {
      Object.entries(effects).forEach(([key, delta]) => {
        if (typeof delta === "number" && key in state) {
          state[key] += delta;
        }
      });

      applyDebtPenalty();
      clampAllStats();
      updateRealmProgression();
    }

    function summarizeEffects(effects) {
      return Object.entries(effects)
        .map(([key, delta]) => `<span class='${delta < 0 ? "bad" : "good"}'>${delta > 0 ? "+" : ""}${delta} ${key}</span>`)
        .join(", ");
    }

    function statsRows() {
      return [
        ["Sect Name", state.sectName],
        ["Leader Realm", state.leaderRealm],
        ["Sect Power", state.sectPower],
        ["Disciples", state.disciples],
        ["Spirit Stones", state.spiritStones],
        ["Reputation", state.reputation],
        ["Loyalty", state.loyalty],
        ["Heavenly Fate Tokens", state.heavenlyFateTokens]
      ];
    }

    function renderStats() {
      ui.stats.innerHTML = "";
      statsRows().forEach(([label, value]) => {
        const card = document.createElement("div");
        card.className = "stat-card";
        card.innerHTML = `<small>${label}</small><strong>${value}</strong>`;
        ui.stats.appendChild(card);
      });
    }

    function renderEvent() {
      ui.turnLabel.textContent = `Turn ${state.turn} Â· ${SEASONS[state.seasonIndex]}`;
      ui.eventText.textContent = currentEvent.text;
      ui.choices.innerHTML = "";

      currentEvent.choices.forEach((choice, index) => {
        const btn = document.createElement("button");
        btn.textContent = `${index + 1}. ${choice.label}`;
        btn.addEventListener("click", () => resolveChoice(choice));
        ui.choices.appendChild(btn);
      });

      ui.rewindBtn.disabled = true;
      ui.status.textContent = "Issue your sect decree for this season.";
    }

    function applyLoseCondition() {
      if (state.sectPower > 0) return;

      state.lost = true;
      Array.from(ui.choices.querySelectorAll("button")).forEach((btn) => (btn.disabled = true));

      if (state.heavenlyFateTokens > 0 && previousTurnSnapshot) {
        ui.status.textContent = "Sect collapse. Spend 1 Heavenly Fate Token to rewind one turn.";
        ui.rewindBtn.disabled = false;
      } else {
        ui.status.textContent = "Your sect has fallen. Heavenly Fate is exhausted.";
      }
    }

    function resolveChoice(choice) {
      if (state.lost) return;

      previousTurnSnapshot = {
        state: structuredClone(state),
        event: structuredClone(currentEvent)
      };

      applyChoiceEffects(choice.effects);
      logEntry(`<strong>${SEASONS[state.seasonIndex]} Turn ${state.turn}:</strong> ${choice.label}<br>${summarizeEffects(choice.effects)}`);
      rollInternalRebellion();

      applyLoseCondition();
      renderStats();

      if (state.lost) return;

      state.turn += 1;
      state.seasonIndex = (state.seasonIndex + 1) % SEASONS.length;
      currentEvent = pickRandomEvent();
      renderEvent();
    }

    function rewindTurn() {
      if (!state.lost || !previousTurnSnapshot || state.heavenlyFateTokens <= 0) return;

      const remainingTokens = state.heavenlyFateTokens - 1;
      state = structuredClone(previousTurnSnapshot.state);
      state.heavenlyFateTokens = remainingTokens;
      state.lost = false;
      currentEvent = structuredClone(previousTurnSnapshot.event);

      logEntry("<strong>Heavenly Fate Reversal:</strong> Causality rewound by one turn.");
      renderStats();
      renderEvent();
      ui.status.textContent = "Fate rewound. Choose a different decision.";
    }

    function restartGame() {
      state = initialState();
      previousTurnSnapshot = null;
      currentEvent = pickRandomEvent();
      ui.log.innerHTML = "";
      logEntry("<strong>New Era:</strong> You inherit leadership of the sect.");
      renderStats();
      renderEvent();
    }

    ui.rewindBtn.addEventListener("click", rewindTurn);
    ui.restartBtn.addEventListener("click", restartGame);

    restartGame();
  </script>
</body>
</html>
