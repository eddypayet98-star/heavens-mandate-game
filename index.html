<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cultivation Sect Leader Simulator</title>
  <style>
    :root {
      --bg: #0b0d12;
      --panel: #121722;
      --panel-2: #181f2c;
      --text: #e8edf7;
      --muted: #93a0b9;
      --accent: #8f7cff;
      --good: #64dca9;
      --bad: #ff7b91;
      --border: #2b364d;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #121827 0%, var(--bg) 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
    }

    .game {
      width: min(960px, 100%);
      display: grid;
      gap: 1rem;
    }

    .panel {
      background: linear-gradient(145deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.75rem;
    }

    .stat {
      padding: 0.7rem;
      border-radius: 8px;
      background: rgba(143, 124, 255, 0.08);
      border: 1px solid rgba(143, 124, 255, 0.22);
    }

    .stat small {
      display: block;
      color: var(--muted);
      font-size: 0.78rem;
      margin-bottom: 0.2rem;
    }

    .stat strong {
      font-size: 1rem;
      font-weight: 600;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.8rem;
      letter-spacing: 0.04em;
    }

    #turnLabel {
      color: var(--muted);
      margin-bottom: 0.75rem;
      display: block;
    }

    #eventText {
      line-height: 1.6;
      margin-bottom: 1rem;
      color: #d4ddf2;
      min-height: 70px;
    }

    .choices {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
    }

    button {
      padding: 0.8rem 0.9rem;
      border-radius: 8px;
      border: 1px solid #3a4770;
      background: #1f2940;
      color: var(--text);
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      transition: 0.2s ease;
    }

    button:hover:not(:disabled) {
      background: #2a3654;
      border-color: #5d70a5;
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #log {
      max-height: 220px;
      overflow: auto;
      display: grid;
      gap: 0.55rem;
      padding-right: 0.3rem;
    }

    .log-item {
      border-left: 3px solid var(--accent);
      padding-left: 0.65rem;
      color: #c6d0e8;
      font-size: 0.92rem;
    }

    .good {
      color: var(--good);
    }

    .bad {
      color: var(--bad);
    }

    #status {
      margin-top: 0.65rem;
      min-height: 1.2rem;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .actions {
      margin-top: 0.8rem;
      display: flex;
      gap: 0.6rem;
    }

    #rewindBtn {
      background: #392243;
      border-color: #744091;
    }

    #restartBtn {
      background: #203049;
      border-color: #3d6ba4;
    }

    @media (max-width: 800px) {
      .stats-grid,
      .choices {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 540px) {
      .stats-grid,
      .choices {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="game">
    <section class="panel">
      <h1>Cultivation Sect Leader Simulator</h1>
      <div class="stats-grid" id="stats"></div>
    </section>

    <section class="panel">
      <span id="turnLabel"></span>
      <p id="eventText"></p>
      <div class="choices" id="choices"></div>
      <div id="status"></div>
      <div class="actions">
        <button id="rewindBtn" disabled>Use Heavenly Fate Rewind</button>
        <button id="restartBtn">Restart Game</button>
      </div>
    </section>

    <section class="panel">
      <h2 style="font-size:1.1rem;margin-bottom:0.75rem;">Sect Chronicle</h2>
      <div id="log"></div>
    </section>
  </main>

  <script>
    const seasonNames = ["Spring", "Summer", "Autumn", "Winter"];

    const STAT_LIMITS = {
      sectPower: { min: -999, max: 220 },
      disciples: { min: 0, max: 300 },
      spiritStones: { min: -200, max: 1200 },
      reputation: { min: 0, max: 100 },
      loyalty: { min: 0, max: 100 },
      heavenlyFateTokens: { min: 0, max: 9 }
    };

    const REALM_TRACK = [
      { name: "Qi Gathering", threshold: 0 },
      { name: "Foundation Establishment", threshold: 60 },
      { name: "Core Formation", threshold: 105 },
      { name: "Nascent Soul", threshold: 155 }
    ];

    const initialState = () => ({
      sectName: "Azure Ascendant Sect",
      leaderRealm: "Qi Gathering",
      realmStage: 0,
      sectPower: 35,
      disciples: 24,
      spiritStones: 90,
      reputation: 22,
      loyalty: 68,
      heavenlyFateTokens: 3,
      turn: 1,
      seasonIndex: 0,
      lost: false
    });

    let state = initialState();
    let previousTurnSnapshot = null;
    let currentEvent = null;

    const events = [
      {
        text: "A rogue elder from a rival sect seeks shelter. Their techniques are powerful but their loyalty is uncertain.",
        choices: [
          { label: "Accept them as instructor", effects: { sectPower: 5, loyalty: -5, reputation: -3 } },
          { label: "Reject and drive them away", effects: { reputation: 3, sectPower: -2, loyalty: 1 } },
          { label: "Imprison and extract manuals", effects: { spiritStones: 12, sectPower: 3, reputation: -7, loyalty: -5 } },
          { label: "Offer passage and send a gift", effects: { spiritStones: -9, reputation: 5, loyalty: 3 } }
        ]
      },
      {
        text: "A spirit mine under your territory begins to collapse after unstable qi surges.",
        choices: [
          { label: "Spend heavily to stabilize the mine", effects: { spiritStones: -18, sectPower: 3, disciples: 1 } },
          { label: "Evacuate and seal it", effects: { sectPower: -3, loyalty: 2, reputation: 2 } },
          { label: "Force disciples to continue extraction", effects: { spiritStones: 18, loyalty: -8, disciples: -2 } },
          { label: "Invite an allied sect to co-manage", effects: { reputation: 4, spiritStones: 6, sectPower: 1 } }
        ]
      },
      {
        text: "A heavenly phenomenon appears over your mountain. Cultivators gather, sensing opportunity.",
        choices: [
          { label: "Host an open enlightenment forum", effects: { reputation: 6, spiritStones: -8, disciples: 2 } },
          { label: "Restrict access and harvest the omen", effects: { sectPower: 4, reputation: -4, loyalty: -2 } },
          { label: "Auction access rights", effects: { spiritStones: 16, reputation: -2, sectPower: 1 } },
          { label: "Meditate in seclusion as leader", effects: { sectPower: 3, loyalty: 2 } }
        ]
      },
      {
        text: "Outer disciples demand better resource distribution after repeated dangerous missions.",
        choices: [
          { label: "Raise stipends immediately", effects: { spiritStones: -14, loyalty: 8, reputation: 1 } },
          { label: "Hold a stern assembly and deny requests", effects: { loyalty: -8, sectPower: 2 } },
          { label: "Promote only top performers", effects: { sectPower: 3, loyalty: -3, disciples: -1 } },
          { label: "Let elders negotiate compromise", effects: { loyalty: 3, reputation: 2, spiritStones: -6 } }
        ]
      },
      {
        text: "A demonic beast tide approaches nearby villages under your nominal protection.",
        choices: [
          { label: "Lead disciples personally into battle", effects: { sectPower: 4, disciples: -2, reputation: 7 } },
          { label: "Fortify sect gates and ignore villages", effects: { sectPower: 2, reputation: -8, loyalty: -4 } },
          { label: "Hire mercenary cultivators", effects: { spiritStones: -13, reputation: 4, sectPower: 2 } },
          { label: "Offer talismans and evacuate civilians", effects: { spiritStones: -8, loyalty: 4, reputation: 5 } }
        ]
      }
    ];

    const statsContainer = document.getElementById("stats");
    const turnLabel = document.getElementById("turnLabel");
    const eventText = document.getElementById("eventText");
    const choicesContainer = document.getElementById("choices");
    const statusLabel = document.getElementById("status");
    const logContainer = document.getElementById("log");
    const rewindBtn = document.getElementById("rewindBtn");
    const restartBtn = document.getElementById("restartBtn");

    function clampStat(key, value) {
      if (!STAT_LIMITS[key]) return value;
      const { min, max } = STAT_LIMITS[key];
      return Math.min(max, Math.max(min, value));
    }

    function clampAllStats() {
      Object.keys(STAT_LIMITS).forEach((key) => {
        state[key] = clampStat(key, state[key]);
      });
    }

    function updateRealmFromPower() {
      let highestReached = 0;
      for (let i = 0; i < REALM_TRACK.length; i += 1) {
        if (state.sectPower >= REALM_TRACK[i].threshold) {
          highestReached = i;
        }
      }

      if (highestReached > state.realmStage) {
        state.realmStage += 1;
        state.leaderRealm = REALM_TRACK[state.realmStage].name;
        addLog(`<strong>Realm Breakthrough:</strong> The Sect Leader reaches ${state.leaderRealm}.`);
      }
    }

    function getStatsDisplay() {
      return [
        ["Sect Name", state.sectName],
        ["Leader Realm", state.leaderRealm],
        ["Sect Power", state.sectPower],
        ["Disciples", state.disciples],
        ["Spirit Stones", state.spiritStones],
        ["Reputation", state.reputation],
        ["Loyalty", state.loyalty],
        ["Heavenly Fate Tokens", state.heavenlyFateTokens]
      ];
    }

    function renderStats() {
      statsContainer.innerHTML = "";
      getStatsDisplay().forEach(([key, value]) => {
        const card = document.createElement("div");
        card.className = "stat";
        card.innerHTML = `<small>${key}</small><strong>${value}</strong>`;
        statsContainer.appendChild(card);
      });
    }

    function getDifficultyMultiplier() {
      const stage = Math.floor(state.sectPower / 40);
      return Math.min(2.3, 1 + stage * 0.15);
    }

    function scaleEventForDifficulty(event) {
      const multiplier = getDifficultyMultiplier();
      const scaledEvent = JSON.parse(JSON.stringify(event));

      scaledEvent.choices = scaledEvent.choices.map((choice) => {
        const adjusted = { ...choice, effects: { ...choice.effects } };
        Object.entries(adjusted.effects).forEach(([key, value]) => {
          if (typeof value !== "number") return;

          if (value > 0) {
            adjusted.effects[key] = Math.max(1, Math.round(value / multiplier));
          } else if (value < 0) {
            adjusted.effects[key] = Math.min(-1, Math.round(value * multiplier));
          }
        });
        return adjusted;
      });

      return scaledEvent;
    }

    function pickRandomEvent() {
      const i = Math.floor(Math.random() * events.length);
      return scaleEventForDifficulty(events[i]);
    }

    function renderEvent() {
      turnLabel.textContent = `Turn ${state.turn} Â· ${seasonNames[state.seasonIndex]}`;
      eventText.textContent = currentEvent.text;
      choicesContainer.innerHTML = "";

      currentEvent.choices.forEach((choice, index) => {
        const btn = document.createElement("button");
        btn.textContent = `${index + 1}. ${choice.label}`;
        btn.addEventListener("click", () => resolveChoice(choice));
        choicesContainer.appendChild(btn);
      });

      rewindBtn.disabled = true;
      statusLabel.textContent = "Choose a course of action.";
    }

    function summarizeEffects(effects) {
      return Object.entries(effects)
        .map(([key, value]) => {
          const display = `${value >= 0 ? "+" : ""}${value} ${key}`;
          return `<span class="${value < 0 ? "bad" : "good"}">${display}</span>`;
        })
        .join(", ");
    }

    function addLog(message) {
      const item = document.createElement("div");
      item.className = "log-item";
      item.innerHTML = message;
      logContainer.prepend(item);
    }

    function applySeasonUpkeep() {
      if (state.spiritStones < 0) {
        const shortage = Math.abs(state.spiritStones);
        const loyaltyPenalty = Math.max(1, Math.ceil(shortage / 25));
        state.loyalty -= loyaltyPenalty;
        addLog(`<strong>Resource Shortage:</strong> -${loyaltyPenalty} loyalty from spirit stone debt.`);
      }
    }

    function applyEffects(effects) {
      Object.entries(effects).forEach(([key, value]) => {
        if (typeof value === "number" && key in state) {
          state[key] += value;
        }
      });

      applySeasonUpkeep();
      clampAllStats();
      updateRealmFromPower();
    }

    function checkLoseCondition() {
      if (state.sectPower <= 0) {
        state.lost = true;
        Array.from(choicesContainer.querySelectorAll("button")).forEach((btn) => (btn.disabled = true));
        if (state.heavenlyFateTokens > 0 && previousTurnSnapshot) {
          statusLabel.innerHTML = "Sect power has collapsed. Spend 1 Heavenly Fate Token to rewind one turn.";
          rewindBtn.disabled = false;
        } else {
          statusLabel.textContent = "Your sect has fallen. No Heavenly Fate remains.";
        }
      }
    }

    function resolveChoice(choice) {
      if (state.lost) return;

      previousTurnSnapshot = {
        state: JSON.parse(JSON.stringify(state)),
        event: JSON.parse(JSON.stringify(currentEvent))
      };

      applyEffects(choice.effects);
      addLog(`<strong>${seasonNames[state.seasonIndex]} Turn ${state.turn}:</strong> ${choice.label}<br>${summarizeEffects(choice.effects)}`);

      checkLoseCondition();
      renderStats();

      if (!state.lost) {
        state.turn += 1;
        state.seasonIndex = (state.seasonIndex + 1) % seasonNames.length;
        currentEvent = pickRandomEvent();
        renderEvent();
      }
    }

    function rewindTurn() {
      if (!state.lost || state.heavenlyFateTokens <= 0 || !previousTurnSnapshot) return;

      const tokenAfterSpend = state.heavenlyFateTokens - 1;
      state = JSON.parse(JSON.stringify(previousTurnSnapshot.state));
      state.heavenlyFateTokens = tokenAfterSpend;
      state.lost = false;
      currentEvent = JSON.parse(JSON.stringify(previousTurnSnapshot.event));

      addLog(`<strong>Heavenly Fate Reversal:</strong> You bent causality and returned to ${seasonNames[state.seasonIndex]} Turn ${state.turn}.`);

      renderStats();
      renderEvent();
      statusLabel.textContent = "Turn rewound. Choose a different path.";
    }

    function restartGame() {
      state = initialState();
      previousTurnSnapshot = null;
      currentEvent = pickRandomEvent();
      logContainer.innerHTML = "";
      addLog("<strong>New Era:</strong> You ascend as sect leader. The first season begins.");
      renderStats();
      renderEvent();
    }

    rewindBtn.addEventListener("click", rewindTurn);
    restartBtn.addEventListener("click", restartGame);

    restartGame();
  </script>
</body>
</html>
